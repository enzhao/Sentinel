version: '3'

# Define a variable for the utility environment's Python executable
vars:
  UTIL_PYTHON: venv_util/bin/python

tasks:
  # Generates the source Mermaid diagrams from the ui_flows_spec.yaml file
  spec:generate-flow-diagrams:
    desc: Generates the source Mermaid diagrams from the ui_flows_spec.yaml file.
    cmds:
      - echo "Generating Mermaid diagrams from flow specs..."
      - "{{.UTIL_PYTHON}} util/generate_ui_flow_visuals_mermaid.py docs/specs/ui_flows_spec.yaml"
      - echo "Source diagrams generated in docs/ui_flow_diagrams.md."
    silent: false

  # Updates the product_spec.md with the latest generated Mermaid diagrams
  spec:sync-flow-diagrams-to-spec:
    desc: Updates the product_spec.md with the latest generated Mermaid diagrams.
    cmds:
      - echo "Synchronizing diagrams into product_spec.md..."
      - "{{.UTIL_PYTHON}} util/update_flow_diagrams_in_product_spec.py docs/ui_flow_diagrams.md product_spec.md"
      - echo "Product spec diagrams are up to date."
    silent: false
  
  spec:update-flow-diagrams-in-product_spec:
    desc: "Generates and updates all flow diagrams in the product spec."
    cmds:
      - task: spec:generate-flow-diagrams
      - task: spec:sync-flow-diagrams-to-spec
    silent: false

  generate-messages:
    desc: "Parses product_spec.md to generate message files for frontend and backend."
    cmds:
      - echo "ðŸ Generating message files from product_spec.md..."
      - backend/venv/bin/python util/generate_messages.py
      - echo "âœ… Message files generated."
    silent: false

  backend:compile-deps:
    desc: "Generates requirements.txt from .in files using pip-compile."
    dir: backend
    cmds:
      - echo "ðŸ Compiling production dependencies..."
      - venv/bin/pip-compile requirements.in
      - echo "ðŸ Compiling development dependencies..."
      - venv/bin/pip-compile requirements-dev.in
      - echo "âœ… Dependency files generated."
    silent: false

  backend:install-deps:
    desc: "Installs backend Python dependencies using pip-tools."
    dir: backend
    cmds:
      - echo "ðŸ Installing/syncing Python dependencies..."
      - venv/bin/pip-sync requirements.txt requirements-dev.txt
      - echo "âœ… Dependencies are up to date."
    silent: false

  backend:sync-deps:
    desc: "Compiles and installs/syncs backend dependencies in one step."
    cmds:
      - task: backend:compile-deps
      - task: backend:install-deps
    silent: false

  backend:test:
    desc: "Runs backend unit and integration tests with pytest."
    dir: backend
    cmds:
      - echo "ðŸ§ª Running backend tests with coverage..."
      - venv/bin/pytest --cov=src
    silent: false

  backend:build-docker:
    desc: "Builds the production Docker image for the backend."
    cmds:
      - echo "ðŸ³ Building Docker image..."
      - docker build -t sentinel-backend ./backend
      - echo "âœ… Docker image 'sentinel-backend' built."
    silent: false

  backend:run-docker:
    desc: "Runs the backend Docker container."
    cmds:
      - echo "ðŸš€ Running backend container..."
      - >
        docker run --rm -p 8000:8000 
        -e ENV=dev 
        -v $(pwd)/backend/serviceAccountKey.json:/app/serviceAccountKey.json 
        -v $(pwd)/backend/.env:/app/.env 
        sentinel-backend
    silent: false

  backend:run-local:
    desc: "Runs the full local backend workflow: test, build, and run."
    cmds:
      - task: backend:test
      - task: backend:build-docker
      - task: backend:run-docker
    silent: false

